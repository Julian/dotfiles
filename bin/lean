#!/usr/bin/env python3

from pathlib import Path
import os
import re
import subprocess
import sys


LEAN3_MARKER = re.compile(r'"leanprover(?:|-community)/lean:(.*)"')
LEANPKG = Path("leanpkg.toml")

LEAN3_DIR = Path(
    os.environ.get("LEAN3_DIR", os.path.expanduser("~/.local/share/lean/")),
)
LEAN4_DIR = Path(
    os.environ.get("LEAN4_DIR", os.path.expanduser("/opt/lean4/")),
)
LEAN_DEFAULT_VERSION = os.environ.get("LEAN_DEFAULT_VERSION")


parent = subprocess.run(
    ["ps", "-o", "command", "-p", str(os.getppid())],
    capture_output=True,
).stdout.strip()
needs_lean3 = any(
    each in parent
    for each in {b"lean-language-server", b"leanproject", b"lean3ls"}
)


def lean3(version):
    return LEAN3_DIR / f"lean-{version}-darwin"


def lean4(version):
    return LEAN4_DIR / "nightly"


if LEANPKG.exists():
    match = LEAN3_MARKER.search(LEANPKG.read_text())
    version = match.group(1) if match is not None else LEAN_DEFAULT_VERSION
else:
    version = LEAN_DEFAULT_VERSION

if not version:
    if needs_lean3:
        version = max(
            LEAN3_DIR.glob("lean-*-darwin"),
            key=lambda p: tuple(map(int, p.name.split("-")[1].split("."))),
        )
    else:
        version = "4.0.0"


fn = lean3 if version.startswith("3") else lean4
executable = Path(sys.argv[0]).name
lean = fn(version) / "bin" / executable
os.execvp(lean, [lean] + sys.argv[1:])
